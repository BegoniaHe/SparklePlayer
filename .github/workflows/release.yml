name: Build and Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Release version'
        required: true
        default: 'v1.0.0'

jobs:
  build-and-release:
    runs-on: ubuntu-latest
    
    permissions:
      contents: write
      
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up JDK 8
      uses: actions/setup-java@v4
      with:
        java-version: '8'
        distribution: 'temurin'
        
    - name: Grant execute permission for gradlew
      run: chmod +x gradlew
      
    - name: Delete all prereleases
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        echo "Deleting existing prereleases..."
        # è·å–æ‰€æœ‰çš„é¢„å‘å¸ƒç‰ˆæœ¬
        prereleases=$(gh release list --json tagName,isPrerelease --jq '.[] | select(.isPrerelease == true) | .tagName')
        
        if [ -n "$prereleases" ]; then
          echo "Found prereleases to delete:"
          echo "$prereleases"
          
          # åˆ é™¤æ¯ä¸ªé¢„å‘å¸ƒç‰ˆæœ¬
          echo "$prereleases" | while read -r tag; do
            if [ -n "$tag" ]; then
              echo "Deleting prerelease: $tag"
              gh release delete "$tag" --yes || echo "Failed to delete $tag"
            fi
          done
        else
          echo "No prereleases found to delete"
        fi
        
    - name: Build JAR with Gradle
      run: |
        echo "Building JAR file..."
        # è·³è¿‡ä»£ç è´¨é‡æ£€æŸ¥ï¼Œåªè¿›è¡Œç¼–è¯‘å’Œæ‰“åŒ…
        ./gradlew clean compileJava jar -x checkstyleMain -x pmdMain -x spotbugsMain
        
    - name: Find JAR file
      id: find-jar
      run: |
        # æŸ¥æ‰¾ç”Ÿæˆçš„JARæ–‡ä»¶
        jar_file=$(find build/libs -name "*.jar" -type f | head -1)
        if [ -z "$jar_file" ]; then
          echo "No JAR file found in build/libs/"
          exit 1
        fi
        echo "Found JAR: $jar_file"
        echo "jar_path=$jar_file" >> $GITHUB_OUTPUT
        echo "jar_name=$(basename $jar_file)" >> $GITHUB_OUTPUT
        
    - name: Prepare release assets
      run: |
        echo "Preparing release assets..."
        mkdir -p release-assets
        
        # å¤åˆ¶JARæ–‡ä»¶
        cp "${{ steps.find-jar.outputs.jar_path }}" release-assets/
        
        # å¤åˆ¶sparkleplayerç›®å½•
        cp -r sparkleplayer release-assets/
        
        # åˆ›å»ºå‹ç¼©åŒ…
        cd release-assets
        zip -r ../SparklePlayer-Release.zip .
        cd ..
        
        echo "Release assets prepared:"
        ls -la release-assets/
        ls -la SparklePlayer-Release.zip
        
    - name: Get version
      id: get-version
      run: |
        if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
          version="${{ github.event.inputs.version }}"
        else
          version="${{ github.ref_name }}"
        fi
        echo "version=$version" >> $GITHUB_OUTPUT
        echo "Using version: $version"
        
    - name: Create prerelease
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        version="${{ steps.get-version.outputs.version }}"
        jar_name="${{ steps.find-jar.outputs.jar_name }}"
        
        echo "Creating prerelease $version..."
        
        # åˆ›å»ºé¢„å‘å¸ƒç‰ˆæœ¬
        gh release create "$version" \
          --title "SparklePlayer $version (Pre-release)" \
          --notes "ğŸš€ **SparklePlayer Pre-release $version**

        è¿™æ˜¯ä¸€ä¸ªé¢„å‘å¸ƒç‰ˆæœ¬ï¼ŒåŒ…å«æœ€æ–°çš„åŠŸèƒ½å’Œä¿®å¤ã€‚

        ## ğŸ“¦ åŒ…å«å†…å®¹
        - \`$jar_name\` - ä¸»ç¨‹åºJARæ–‡ä»¶
        - \`SparklePlayer-Release.zip\` - å®Œæ•´å‘å¸ƒåŒ…ï¼ˆåŒ…å«JARæ–‡ä»¶å’Œsparkleplayerç›®å½•ï¼‰
        - \`sparkleplayer/\` ç›®å½• - åŒ…å«éŸ³é¢‘æ–‡ä»¶ã€å­—ä½“ã€å›¾æ ‡ç­‰èµ„æº

        ## ğŸ”§ è¿è¡Œæ–¹å¼
        1. ä¸‹è½½ \`SparklePlayer-Release.zip\` å¹¶è§£å‹
        2. ç¡®ä¿å·²å®‰è£… Java 8 æˆ–æ›´é«˜ç‰ˆæœ¬
        3. è¿è¡Œ: \`java -jar $jar_name\`

        ## âš ï¸ æ³¨æ„
        è¿™æ˜¯é¢„å‘å¸ƒç‰ˆæœ¬ï¼Œå¯èƒ½åŒ…å«æœªå®Œå…¨æµ‹è¯•çš„åŠŸèƒ½ã€‚è¯·è°¨æ…åœ¨ç”Ÿäº§ç¯å¢ƒä¸­ä½¿ç”¨ã€‚

        ---
        æ„å»ºæ—¶é—´: $(date -u '+%Y-%m-%d %H:%M:%S UTC')
        æäº¤: ${{ github.sha }}" \
          --prerelease \
          "${{ steps.find-jar.outputs.jar_path }}" \
          "SparklePlayer-Release.zip"
          
        echo "âœ… Prerelease $version created successfully!"
